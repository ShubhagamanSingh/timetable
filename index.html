<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE CSE 2026 Strategic Planner</title>
    <!-- Icons & Share Image -->
    <link rel="icon" type="image/png" href="img/icon.png">
    <link rel="apple-touch-icon" href="img/icon.png">
    <meta property="og:image" content="img/icon.png">
    <meta name="twitter:image" content="img/icon.png">
    <link rel="manifest" href="manifest.json">
    <!-- Mobile Widget / PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(203, 213, 225, 0.5); border-radius: 20px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background-color: rgba(148, 163, 184, 0.8); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .transition-all-smooth { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Calendar Styles */
        .calendar-day:hover { background-color: #EEF2FF; }
        .calendar-day.today { border: 2px solid #4F46E5; font-weight: bold; }
        .calendar-day.has-topic { background-color: #E0E7FF; color: #4338CA; }
        
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #E2E8F0;
            border-radius: 2px;
        }

        /* Widget Mode Styles (Triggered by ?mode=widget) */
        body.widget-mode { background-color: transparent !important; min-height: 0 !important; }
        body.widget-mode header,
        body.widget-mode #day-nav,
        body.widget-mode .lg\:hidden.fixed,
        body.widget-mode #mobile-dashboard-modal { display: none !important; }
        body.widget-mode main { padding: 0 !important; display: block !important; width: 100% !important; max-width: 100% !important; }
        body.widget-mode #dashboard-sidebar { display: none !important; }
        body.widget-mode .animate-enter { box-shadow: none; border: none; margin: 0 !important; width: 100% !important; border-radius: 0 !important; }

        /* Focus Mode 3D Animation */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .animate-spin-slow { animation: spin-3d 8s linear infinite; }
        .animate-spin-reverse { animation: spin-3d-reverse 12s linear infinite; }
        
        @keyframes spin-3d {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            100% { transform: rotateX(360deg) rotateY(180deg) rotateZ(360deg); }
        }
        @keyframes spin-3d-reverse {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            100% { transform: rotateX(-360deg) rotateY(-180deg) rotateZ(-360deg); }
        }

        .atom-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-100 dark:bg-slate-950 text-slate-800 dark:text-slate-200 pb-20 lg:pb-12 flex flex-col transition-colors duration-300">

    <!-- Netlify Backup Form (Hidden) -->
    <form name="backup" netlify hidden>
        <input type="text" name="data" />
        <input type="text" name="timestamp" />
    </form>

    <!-- Navbar -->
    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-20 shadow-sm flex-none transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="img/icon.png" class="w-10 h-10 rounded-lg shadow-sm object-cover" alt="Logo">
                <div>
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white leading-none">GATE '26</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Strategic Planner</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-6">
                <div class="text-right">
                    <div class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">Time Remaining</div>
                    <div id="desktop-countdown" class="text-sm font-bold text-indigo-600 font-mono">Loading...</div>
                </div>
                <div class="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
                <div class="text-right">
                    <div class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">Weekly Goal</div>
                    <div id="desktop-hours" class="text-sm font-bold text-emerald-600 font-mono">0 Hours</div>
                </div>
                <div class="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
                </div>
                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 py-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- LEFT COLUMN: Scheduler (Takes up 8 columns on Desktop) -->
        <div class="lg:col-span-8 flex flex-col">
            <!-- Mobile Stats -->
            <div class="md:hidden grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white dark:bg-slate-900 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800 text-center">
                    <div class="text-[10px] text-slate-400 dark:text-slate-500 uppercase font-bold tracking-wide">Days Left</div>
                    <div id="mobile-countdown-days" class="text-xl font-bold text-indigo-600">--</div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800 text-center">
                    <div class="text-[10px] text-slate-400 dark:text-slate-500 uppercase font-bold tracking-wide">Wkly Hours</div>
                    <div id="mobile-hours" class="text-xl font-bold text-emerald-600">--</div>
                </div>
            </div>

            <!-- Day Slider Navigation -->
            <div class="relative mb-6">
                <div class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-slate-100 dark:from-slate-950 to-transparent z-10 pointer-events-none"></div>
                <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-slate-100 dark:from-slate-950 to-transparent z-10 pointer-events-none"></div>
                <div id="day-nav" class="flex overflow-x-auto no-scrollbar gap-2 py-1 px-1 snap-x scroll-smooth md:justify-center"></div>
            </div>

            <!-- Active Content Area -->
            <div id="active-content" class="flex-1 flex flex-col gap-6"></div>
        </div>

        <!-- RIGHT COLUMN: Dashboard (Takes up 4 columns on Desktop, Hidden on Mobile unless toggled) -->
        <div id="dashboard-sidebar" class="hidden lg:flex lg:col-span-4 flex-col gap-6">
            <!-- Reusable Dashboard Content Function will populate this -->
        </div>

    </main>

    <!-- Mobile Dashboard Toggle (Floating Action Button) -->
    <button onclick="toggleMobileDashboard()" class="lg:hidden fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-lg z-50 hover:bg-indigo-700 transition-colors shadow-indigo-500/30">
        <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
    </button>

    <!-- Mobile Dashboard Modal Overlay -->
    <div id="mobile-dashboard-modal" class="fixed inset-0 bg-slate-900/50 z-40 hidden flex justify-end">
        <div class="bg-slate-100 dark:bg-slate-900 w-full max-w-md h-full overflow-y-auto p-6 flex flex-col gap-6 shadow-2xl transform transition-transform duration-300 translate-x-full" id="mobile-dashboard-content">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">My Dashboard</h2>
                <button onclick="toggleMobileDashboard()" class="p-2 bg-white rounded-full text-slate-500 hover:text-slate-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Install Button (Hidden by default) -->
            <button id="install-btn" onclick="installApp()" class="hidden w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-slate-700 transition-colors">
                <i data-lucide="download" class="w-5 h-5"></i> Install App to Home Screen
            </button>
            <!-- Dashboard Content Injected Here for Mobile -->
        </div>
    </div>

    <!-- Focus Mode Modal (Dynamic Box) -->
    <div id="focus-modal" class="fixed inset-0 bg-slate-900/95 z-50 hidden flex flex-col items-center justify-center text-white p-6 backdrop-blur-sm transition-opacity duration-300">
        <button onclick="closeFocusMode()" class="absolute top-6 right-6 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors">
            <i data-lucide="x" class="w-8 h-8 text-white"></i>
        </button>
        
        <!-- 3D Animation Container -->
        <div class="relative w-64 h-64 mb-12 perspective-1000 flex items-center justify-center" id="focus-anim-wrapper">
            <!-- Dynamic Animation Injected Here -->
            <!-- Center Pulse -->
            <div id="glow-wrapper" class="absolute inset-0 flex items-center justify-center">
                <div id="focus-glow" class="w-32 h-32 bg-indigo-600/20 rounded-full blur-xl animate-pulse"></div>
            </div>
            <div id="focus-icon" class="absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_0_15px_rgba(99,102,241,0.8)]"></div>
        </div>

        <!-- Ambient Sound Player -->
        <div class="mb-8 flex items-center gap-3 bg-white/10 p-2 pr-4 rounded-full backdrop-blur-md border border-white/10">
            <button onclick="toggleAudio()" class="p-3 bg-white/20 hover:bg-white/30 rounded-full transition-colors flex-none">
                <i id="audio-icon" data-lucide="play" class="w-5 h-5 text-white fill-current"></i>
            </button>
            <select id="audio-select" onchange="changeAudioSource(this.value)" class="bg-transparent text-white text-sm font-medium focus:outline-none cursor-pointer w-32">
                <option value="" class="text-slate-800">No Sound</option>
                <option value="https://res.cloudinary.com/shubhagaman/video/upload/v1766222284/Divine-Indian-Flute-Music_td0jvv.mp3" class="text-slate-800">Kanha(Flute)</option>
                <option value="audio/deep-healing-432hz.mp3" class="text-slate-800">Calm(432Hz)</option>
                <option value="audio/hare-krishna-relaxing.mp3" class="text-slate-800">Relaxing</option>
            </select>
        </div>

        <h2 id="focus-activity" class="text-3xl md:text-5xl font-bold text-center mb-4 tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 to-white"></h2>
        <div id="focus-timer" class="text-5xl md:text-7xl font-mono font-bold text-indigo-400 tracking-wider drop-shadow-lg tabular-nums">00:00:00</div>
        <p id="focus-range" class="mt-4 text-slate-400 text-lg font-medium tracking-wide"></p>
        <div class="mt-8 flex items-center gap-2 text-sm text-slate-500">
            <i data-lucide="screen-share" class="w-4 h-4"></i> Screen Wake Lock Active
        </div>
    </div>

    <!-- Syllabus Checklist Modal -->
    <div id="syllabus-modal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden animate-enter border border-slate-200 dark:border-slate-800">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
                <h3 id="syllabus-modal-title" class="text-xl font-bold text-slate-800 dark:text-white">Subject Name</h3>
                <button onclick="closeSyllabusModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="syllabus-modal-list" class="p-6 overflow-y-auto scrollbar-thin flex flex-col gap-1">
                <!-- Checklist items injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        const CONSTANTS = {
            EXAM_DATE: '2026-02-01T09:00:00',
            MODES: {
                LIBRARY: 'library',
                HOME: 'home',
            },
            ACTIVITY_TYPES: {
                STUDY: 'study',
                BREAK: 'break',
                CHORE: 'chore',
                REVIEW: 'review',
                REST: 'rest',
            }
        };

        const SUBJECTS = [
            "Data Structures", "Algorithms", "Operating Systems", 
            "DBMS", "Computer Networks", "Theory of Computation", 
            "Compiler Design", "Digital Logic", "COA", "Engineering Math"
        ];

        const SYLLABUS_DATA = {
            "Engineering Math": [
                "Discrete Mathematics: Propositional and first order logic", "Sets, relations, functions, partial orders and lattices", "Monoids, Groups", "Graphs: connectivity, matching, colouring", "Combinatorics: counting, recurrence relations, generating functions",
                "Linear Algebra: Matrices, determinants, system of linear equations", "Eigenvalues and eigenvectors, LU decomposition",
                "Calculus: Limits, continuity and differentiability", "Maxima and minima, Mean value theorem, Integration",
                "Probability and Statistics: Random variables", "Uniform, normal, exponential, Poisson and binomial distributions", "Mean, median, mode and standard deviation", "Conditional probability and Bayes theorem"
            ],
            "Digital Logic": [
                "Boolean algebra", "Combinational and sequential circuits", "Minimization", "Number representations and computer arithmetic (fixed and floating point)"
            ],
            "COA": [
                "Machine instructions and addressing modes", "ALU, data‐path and control unit", "Instruction pipelining, pipeline hazards", "Memory hierarchy: cache, main memory and secondary storage", "I/O interface (interrupt and DMA mode)"
            ],
            "Data Structures": [
                "Programming in C", "Recursion", "Arrays, stacks, queues, linked lists", "Trees, binary search trees, binary heaps", "Graphs"
            ],
            "Algorithms": [
                "Searching, sorting, hashing", "Asymptotic worst case time and space complexity", "Algorithm design techniques: greedy, dynamic programming and divide‐and‐conquer", "Graph traversals, minimum spanning trees, shortest paths"
            ],
            "Theory of Computation": [
                "Regular expressions and finite automata", "Context-free grammars and push-down automata", "Regular and context-free languages, pumping lemma", "Turing machines and undecidability"
            ],
            "Compiler Design": [
                "Lexical analysis, parsing, syntax-directed translation", "Runtime environments", "Intermediate code generation", "Local optimization", "Data flow analyses: constant propagation, liveness analysis, common sub expression elimination"
            ],
            "Operating Systems": [
                "System calls, processes, threads, inter‐process communication", "Concurrency and synchronization, Deadlock", "CPU and I/O scheduling", "Memory management and virtual memory", "File systems"
            ],
            "DBMS": [
                "ER‐model", "Relational model: relational algebra, tuple calculus, SQL", "Integrity constraints, normal forms", "File organization, indexing (e.g., B and B+ trees)", "Transactions and concurrency control"
            ],
            "Computer Networks": [
                "Concept of layering: OSI and TCP/IP Protocol Stacks", "Basics of packet, circuit and virtual circuit- switching", "Data link layer: framing, error detection, Medium Access Control, Ethernet bridging",
                "Routing protocols: shortest path, flooding, distance vector and link state routing", "Fragmentation and IP addressing, IPv4, CIDR notation", "Basics of IP support protocols (ARP, DHCP, ICMP), NAT",
                "Transport layer: flow control and congestion control, UDP, TCP, sockets", "Application layer protocols: DNS, SMTP, HTTP, FTP, Email"
            ]
        };

        const LIBRARY_SCHEDULE = [
            { start: "04:00", end: "06:00", activity: "Meditation & Exercise", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 2 },
            { start: "06:00", end: "08:00", activity: "Strategy & Study Plan", type: CONSTANTS.ACTIVITY_TYPES.REVIEW, duration: 2 },
            { start: "08:00", end: "09:00", activity: "Morning Prep", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 1 },
            { start: "09:00", end: "15:00", activity: "Study Session I", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 6 },
            { start: "15:00", end: "16:00", activity: "Lunch Break", type: CONSTANTS.ACTIVITY_TYPES.BREAK, duration: 1 },
            { start: "16:00", end: "21:30", activity: "Study Session II", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 5.5 },
            { start: "21:30", end: "22:30", activity: "Dinner & Relax", type: CONSTANTS.ACTIVITY_TYPES.BREAK, duration: 1 },
            { start: "22:30", end: "04:00", activity: "Sleep", type: CONSTANTS.ACTIVITY_TYPES.REST, duration: 5.5 },
        ];

        const HOME_SCHEDULE = [
            { start: "04:00", end: "06:00", activity: "Meditation & Exercise", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 2 },
            { start: "06:00", end: "08:00", activity: "Strategy & Study Plan", type: CONSTANTS.ACTIVITY_TYPES.REVIEW, duration: 2 },
            { start: "08:00", end: "09:00", activity: "Morning Prep", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 1 },
            { start: "09:00", end: "12:30", activity: "Morning Study Block", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 3.5 },
            { start: "12:30", end: "14:30", activity: "Kitchen Duties & Lunch", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 2 },
            { start: "14:30", end: "17:30", activity: "Afternoon Study Block", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 3 },
            { start: "17:30", end: "18:00", activity: "Tea / Walk", type: CONSTANTS.ACTIVITY_TYPES.BREAK, duration: 0.5 },
            { start: "18:00", end: "20:00", activity: "Evening Study Block", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 2 },
            { start: "20:00", end: "21:30", activity: "Dinner Prep & Eating", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 1.5 },
            { start: "21:30", end: "22:30", activity: "Night Revision / Extra", type: CONSTANTS.ACTIVITY_TYPES.REVIEW, duration: 1 },
            { start: "22:30", end: "04:00", activity: "Sleep", type: CONSTANTS.ACTIVITY_TYPES.REST, duration: 5.5 },
        ];

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const SHORT_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        const jsDay = new Date().getDay(); 
        const currentDayIndex = jsDay === 0 ? 6 : jsDay - 1;

        // --- Dark Mode Logic ---
        function initTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // --- State Management with LocalStorage ---
        function loadState() {
            const saved = localStorage.getItem('gatePlannerState');
            const defaultState = {
                activeDayIndex: currentDayIndex,
                dayModes: {
                    Monday: CONSTANTS.MODES.LIBRARY, Tuesday: CONSTANTS.MODES.LIBRARY, Wednesday: CONSTANTS.MODES.LIBRARY,
                    Thursday: CONSTANTS.MODES.LIBRARY, Friday: CONSTANTS.MODES.LIBRARY, Saturday: CONSTANTS.MODES.HOME, Sunday: CONSTANTS.MODES.HOME
                },
                checklistProgress: {},
                topicLogs: {}, 
                subjectProgress: SUBJECTS.reduce((acc, sub) => ({...acc, [sub]: 0}), {}), // Default 0%
                calendarMonth: new Date().getMonth(),
                calendarYear: new Date().getFullYear()
            };

            if (saved) {
                const parsed = JSON.parse(saved);
                // Merge to ensure new fields exists if version changes
                return { ...defaultState, ...parsed, activeDayIndex: currentDayIndex, calendarMonth: new Date().getMonth() };
            }
            return defaultState;
        }

        let state = loadState();

        function saveState() {
            localStorage.setItem('gatePlannerState', JSON.stringify(state));
        }

        // --- Logic ---

        function toggleMobileDashboard() {
            const modal = document.getElementById('mobile-dashboard-modal');
            const content = document.getElementById('mobile-dashboard-content');
            
            if (modal.classList.contains('hidden')) {
                // Open
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('translate-x-full');
                }, 10);
                renderDashboard(); // Update views
            } else {
                // Close
                content.classList.add('translate-x-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        function updateProgress(subject, value) {
            state.subjectProgress[subject] = value;
            saveState();
            
            // Use data attributes for robust selection across desktop/mobile
            const safeName = subject.replace(/\s/g, '');
            document.querySelectorAll(`[data-subject-progress-value="${safeName}"]`).forEach(el => el.textContent = `${value}%`);
            document.querySelectorAll(`[data-subject-progress-bar="${safeName}"]`).forEach(el => el.style.width = `${value}%`);
        }

        function openSyllabusModal(subject) {
            const topics = SYLLABUS_DATA[subject] || [];
            const progress = state.checklistProgress[subject] || {};
            
            const listHTML = topics.map((topic) => {
                const isChecked = progress[topic] ? 'checked' : '';
                // Escape single quotes for the onclick handler
                const safeTopic = topic.replace(/'/g, "\\'");
                return `
                    <label class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-colors border border-transparent hover:border-slate-100 dark:hover:border-slate-700 group">
                        <input type="checkbox" onchange="toggleTopic('${subject}', '${safeTopic}')" ${isChecked} class="mt-1 w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 cursor-pointer">
                        <span class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed group-hover:text-slate-900 dark:group-hover:text-white ${isChecked ? 'line-through text-slate-400 dark:text-slate-600' : ''}">${topic}</span>
                    </label>
                `;
            }).join('');

            document.getElementById('syllabus-modal-title').textContent = subject;
            document.getElementById('syllabus-modal-list').innerHTML = listHTML || '<p class="text-slate-400 text-center py-4">No granular topics available.</p>';
            document.getElementById('syllabus-modal').classList.remove('hidden');
        }

        function toggleTopic(subject, topic) {
            if (!state.checklistProgress[subject]) state.checklistProgress[subject] = {};
            if (state.checklistProgress[subject][topic]) {
                delete state.checklistProgress[subject][topic];
            } else {
                state.checklistProgress[subject][topic] = true;
            }
            
            const total = SYLLABUS_DATA[subject].length;
            const checked = Object.keys(state.checklistProgress[subject]).length;
            const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
            
            updateProgress(subject, percent);
            openSyllabusModal(subject); // Re-render to update styles
        }

        function closeSyllabusModal() {
            document.getElementById('syllabus-modal').classList.add('hidden');
        }

        function handleDateClick(day) {
            const dateKey = `${state.calendarYear}-${state.calendarMonth}-${day}`;
            const currentTopic = state.topicLogs?.[dateKey] || "";
            const newTopic = prompt(`Log completed topic for ${state.calendarMonth+1}/${day}:`, currentTopic);
            
            if (newTopic !== null) {
                if(!state.topicLogs) state.topicLogs = {};
                state.topicLogs[dateKey] = newTopic;
                saveState();
                renderDashboard(); // Re-render both views
            }
        }

        function changeMonth(delta) {
            state.calendarMonth += delta;
            if(state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; }
            if(state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; }
            renderDashboard(); // Re-render both views
        }

        // --- Rendering Helpers ---

        function getColors(type) {
            switch (type) {
                case CONSTANTS.ACTIVITY_TYPES.STUDY: return 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300 border-l-4 border-indigo-500';
                case CONSTANTS.ACTIVITY_TYPES.BREAK: return 'bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 border-l-4 border-amber-400';
                case CONSTANTS.ACTIVITY_TYPES.CHORE: return 'bg-rose-50 dark:bg-rose-900/30 text-rose-700 dark:text-rose-300 border-l-4 border-rose-400';
                case CONSTANTS.ACTIVITY_TYPES.REVIEW: return 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 border-l-4 border-emerald-500';
                case CONSTANTS.ACTIVITY_TYPES.REST: return 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-l-4 border-slate-400';
                default: return 'bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300';
            }
        }

        function getIcon(item) {
            const act = item.activity.toLowerCase();
            if (act.includes('meditation') || act.includes('exercise')) return 'dumbbell';
            if (act.includes('strategy')) return 'target';
            if (act.includes('prep') || act.includes('breakfast')) return 'coffee';
            if (act.includes('lunch') || act.includes('dinner') || act.includes('eating')) return 'utensils';
            if (act.includes('walk')) return 'footprints';
            if (act.includes('sleep')) return 'moon';
            
            if (item.type === CONSTANTS.ACTIVITY_TYPES.STUDY) return 'book-open';
            if (item.type === CONSTANTS.ACTIVITY_TYPES.BREAK) return 'coffee';
            if (item.type === CONSTANTS.ACTIVITY_TYPES.CHORE) return 'home';
            return 'custom-logo';
        }

        // --- Render Main Scheduler --- 
        function renderNav() {
            const navContainer = document.getElementById('day-nav');
            const html = DAYS.map((day, index) => {
                const isActive = index === state.activeDayIndex;
                const isToday = index === currentDayIndex;
                return `
                    <button onclick="state.activeDayIndex=${index}; renderApp(); document.getElementById('day-nav').children[${index}].scrollIntoView({behavior:'smooth', inline:'center'})"
                        class="flex-none px-6 py-3 rounded-full text-sm font-semibold transition-all-smooth snap-center whitespace-nowrap border ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:border-indigo-300 hover:text-indigo-600 dark:hover:text-indigo-400'}">
                        ${isToday ? 'Today' : SHORT_DAYS[index]}
                    </button>
                `;
            }).join('');
            if (navContainer.innerHTML !== html) navContainer.innerHTML = html;
        }

        function renderActiveCard() {
            const index = state.activeDayIndex;
            const day = DAYS[index];
            const mode = state.dayModes[day];
            const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;
            // Calculate a week index to rotate subjects so all 10 are covered over time
            const currentWeek = Math.floor(Date.now() / (7 * 24 * 60 * 60 * 1000));
            const subject = SUBJECTS[(index + currentWeek) % SUBJECTS.length];
            const studyHours = schedule.reduce((acc, curr) => (curr.type === CONSTANTS.ACTIVITY_TYPES.STUDY || curr.type === CONSTANTS.ACTIVITY_TYPES.REVIEW) ? acc + curr.duration : acc, 0);

            // Time checking logic for highlighting
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const isToday = index === currentDayIndex;
            const isCurrent = (start, end) => {
                if (!isToday) return false;
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);
                const sMin = sh * 60 + sm;
                const eMin = eh * 60 + em;
                return eMin < sMin ? (currentMinutes >= sMin || currentMinutes < eMin) : (currentMinutes >= sMin && currentMinutes < eMin);
            };

            const cardHTML = `
                <div class="animate-enter bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 overflow-hidden flex flex-col flex-1 mx-auto w-full">
                    <div class="p-6 ${mode === CONSTANTS.MODES.LIBRARY ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-500 to-rose-600'} text-white relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 text-white opacity-10 rotate-12"><i data-lucide="calendar" width="140" height="140"></i></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h2 class="text-3xl font-bold mb-1">${day}</h2>
                                    <div class="flex items-center gap-2 text-indigo-100 text-sm font-medium"><i data-lucide="laptop-2" class="w-4 h-4"></i><span>Focus: ${subject}</span></div>
                                </div>
                                <button onclick="state.dayModes['${day}'] = state.dayModes['${day}'] === CONSTANTS.MODES.LIBRARY ? CONSTANTS.MODES.HOME : CONSTANTS.MODES.LIBRARY; saveState(); renderApp();" class="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg backdrop-blur-sm transition-all text-sm font-semibold border border-white/20">
                                    <span>${mode === CONSTANTS.MODES.LIBRARY ? 'Library Mode' : 'Home Mode'}</span><i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-4 mt-6">
                                <div class="bg-black/20 backdrop-blur-sm px-4 py-2 rounded-lg">
                                    <div class="text-xs text-white/70 uppercase font-bold tracking-wider">Total Study</div>
                                    <div class="text-2xl font-bold leading-none mt-1">${studyHours} <span class="text-sm font-normal opacity-80">hrs</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6 bg-slate-50 dark:bg-slate-950 flex-1">
                        ${schedule.map(item => {
                            const active = isCurrent(item.start, item.end);
                            const activeStyles = active ? 'ring-2 ring-indigo-600 ring-offset-2 scale-[1.02] shadow-lg z-10 relative cursor-pointer' : 'hover:shadow-md';
                            
                            let remainingBadge = '';
                            if (active) {
                                const [sh, sm] = item.start.split(':').map(Number);
                                const [eh, em] = item.end.split(':').map(Number);
                                const sMin = sh * 60 + sm;
                                const eMin = eh * 60 + em;
                                let diff = (eMin < sMin) ? ((currentMinutes >= sMin) ? (24 * 60 - currentMinutes) + eMin : eMin - currentMinutes) : (eMin - currentMinutes);
                                
                                const h = Math.floor(diff / 60);
                                const m = diff % 60;
                                const timeText = h > 0 ? `${h}h ${m}m` : `${m}m`;
                                const colorClass = diff < 30 ? 'from-rose-500 to-orange-500' : 'from-indigo-600 to-purple-600';
                                remainingBadge = `<span class="absolute -top-2 -right-2 bg-gradient-to-r ${colorClass} text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg animate-pulse border border-white/20 flex items-center gap-1"><i data-lucide="timer" class="w-3 h-3"></i> <span id="active-badge-timer" data-start="${item.start}" data-end="${item.end}">${timeText} Left</span></span>`;
                            }
                            
                            const iconName = getIcon(item);
                            const iconHTML = iconName === 'custom-logo' 
                                ? `<img src="img/icon.png" class="w-5 h-5 object-contain opacity-80">` 
                                : `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;

                            return `
                            <div ${active ? 'onclick="openFocusMode()"' : ''} class="flex items-center p-4 mb-3 rounded-lg text-sm transition-all ${activeStyles} ${getColors(item.type)} dark:border-l-4 dark:border-opacity-100">
                                ${remainingBadge}
                                <div class="mr-4 opacity-70">${iconHTML}</div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center font-bold text-base mb-1"><span>${item.activity}</span><span class="text-xs opacity-75 font-normal bg-white/50 dark:bg-black/20 px-2 py-0.5 rounded-full whitespace-nowrap">${item.start} - ${item.end}</span></div>
                                    <div class="text-xs opacity-90 flex items-center gap-3"><span class="uppercase tracking-wider font-semibold text-[10px]">${item.type}</span><span>${item.duration} hrs</span></div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
            document.getElementById('active-content').innerHTML = cardHTML;
        }

        // --- Dashboard Rendering ---

        // Helper to generate dashboard HTML, promoting DRY principle
        function getDashboardContentHTML() {
            // Calendar Logic
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const daysInMonth = new Date(state.calendarYear, state.calendarMonth + 1, 0).getDate();
            const firstDay = new Date(state.calendarYear, state.calendarMonth, 1).getDay(); // 0 = Sun
            const startOffset = firstDay === 0 ? 6 : firstDay - 1;
            
            let calendarGrid = Array(startOffset).fill('<div></div>').join('');
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${state.calendarYear}-${state.calendarMonth}-${d}`;
                const hasLog = state.topicLogs?.[dateKey];
                const isToday = d === new Date().getDate() && state.calendarMonth === new Date().getMonth() && state.calendarYear === new Date().getFullYear();
                
                calendarGrid += `
                    <div onclick="handleDateClick(${d})" class="calendar-day ${isToday ? 'today' : ''} ${hasLog ? 'has-topic' : ''} aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer text-sm relative transition-colors bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                        ${d}
                        ${hasLog ? `<div class="w-1.5 h-1.5 bg-indigo-500 rounded-full mt-1"></div>` : ''}
                    </div>
                `;
            }

            // Progress Logic using data-attributes instead of IDs
            const progressHTML = SUBJECTS.map((sub) => {
                const safeName = sub.replace(/\s/g,'');
                const val = state.subjectProgress[sub] || 0;
                return `
                    <div class="mb-4">
                        <div class="flex justify-between text-xs font-semibold mb-1 text-slate-600 dark:text-slate-400 cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors" onclick="openSyllabusModal('${sub}')">
                            <span class="flex items-center gap-1">${sub} <i data-lucide="list-checks" class="w-3 h-3"></i></span>
                            <span data-subject-progress-value="${safeName}" class="text-indigo-600">${val}%</span>
                        </div>
                        <div class="relative h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden cursor-pointer" onclick="openSyllabusModal('${sub}')">
                            <div data-subject-progress-bar="${safeName}" class="absolute top-0 left-0 h-full bg-indigo-500 rounded-full transition-all duration-300" style="width: ${val}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Backup Section
            const backupHTML = `
                <div class="mt-6 pt-6 border-t border-slate-100">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Data Management</h4>
                    <div class="flex flex-col gap-2">
                        <button onclick="backupToNetlify()" id="btn-backup-netlify" class="flex items-center justify-center gap-2 w-full py-2.5 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium shadow-sm">
                            <i data-lucide="cloud-upload" class="w-4 h-4"></i> Backup to Cloud
                        </button>
                        <div class="flex gap-2">
                            <button onclick="exportState()" class="flex-1 flex items-center justify-center gap-2 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium shadow-sm">
                                <i data-lucide="download" class="w-4 h-4"></i> Export
                            </button>
                            <button onclick="document.getElementById('import-file').click()" class="flex-1 flex items-center justify-center gap-2 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-sm font-medium shadow-sm">
                                <i data-lucide="upload" class="w-4 h-4"></i> Import
                            </button>
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importState(this)">
                        </div>
                        <button onclick="requestNotificationPermission()" class="w-full py-2.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm font-medium shadow-sm flex items-center justify-center gap-2">
                            <i data-lucide="bell" class="w-4 h-4"></i> Enable Notifications
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-400 text-center mt-2">Manage your progress data locally or on cloud</p>
                </div>
            `;

            return `
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded text-slate-600 dark:text-slate-300"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <h3 class="font-bold text-slate-800 dark:text-white">${monthNames[state.calendarMonth]} ${state.calendarYear}</h3>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded text-slate-600 dark:text-slate-300"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-slate-400 dark:text-slate-500 uppercase">
                        ${SHORT_DAYS.map(d => `<div>${d.slice(0,1)}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1">${calendarGrid}</div>
                    <div class="mt-3 text-xs text-center text-slate-400 dark:text-slate-500">Tap a date to log covered topics</div>
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-5 flex-1">
                    <div class="flex items-center gap-2 mb-4">
                         <div class="bg-indigo-100 p-1.5 rounded text-indigo-600"><i data-lucide="bar-chart-3" class="w-4 h-4"></i></div>
                         <h3 class="font-bold text-slate-800 dark:text-white">Syllabus Progress</h3>
                    </div>
                    <div class="overflow-y-auto max-h-[400px] pr-2 scrollbar-thin">${progressHTML}</div>
                    ${backupHTML}
                </div>
            `;
        }

        function renderDashboard() {
            const desktopSidebar = document.getElementById('dashboard-sidebar');
            const mobileModalContent = document.getElementById('mobile-dashboard-content');

            // If dragging slider, don't re-render to maintain focus/performance
            if (document.activeElement.type === 'range' && (desktopSidebar.contains(document.activeElement) || mobileModalContent.contains(document.activeElement))) {
                return;
            }

            const dashboardContentHTML = getDashboardContentHTML();

            if (desktopSidebar) {
                desktopSidebar.innerHTML = dashboardContentHTML;
            }
            
            if (mobileModalContent) {
                // For mobile, preserve the header and inject the content
                mobileModalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">My Dashboard</h2>
                        <button onclick="toggleMobileDashboard()" class="p-2 bg-white rounded-full text-slate-500 hover:text-slate-800">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    ${dashboardContentHTML}
                `;
            }
            
            lucide.createIcons();
        }

        function renderApp() {
            renderNav();
            renderActiveCard();
            renderDashboard();
            
            // Calc Totals
            const totalHours = Object.keys(state.dayModes).reduce((acc, day) => {
                const mode = state.dayModes[day];
                const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;
                return acc + schedule.reduce((sAcc, item) => (item.type === CONSTANTS.ACTIVITY_TYPES.STUDY || item.type === CONSTANTS.ACTIVITY_TYPES.REVIEW) ? sAcc + item.duration : sAcc, 0);
            }, 0);
            
            document.getElementById('desktop-hours').textContent = `${totalHours} Hours`;
            document.getElementById('mobile-hours').textContent = totalHours;
            lucide.createIcons();
        }

        // --- Notifications ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("Notifications Enabled", { body: "You will be notified before tasks end.", icon: "img/icon.png" });
                    }
                });
            }
        }

        function checkNotifications() {
            if (Notification.permission !== "granted") return;
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            // Check TODAY'S schedule, not necessarily the active view
            const todayIndex = (new Date().getDay() + 6) % 7; // Mon=0
            const todayName = DAYS[todayIndex];
            const mode = state.dayModes[todayName];
            const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;

            schedule.forEach(item => {
                const [eh, em] = item.end.split(':').map(Number);
                const endMinutes = eh * 60 + em;
                if (endMinutes - currentMinutes === 5) new Notification("Upcoming Transition", { body: `5 minutes left for ${item.activity}`, icon: "img/icon.png" });
                if (item.type === CONSTANTS.ACTIVITY_TYPES.BREAK && endMinutes === currentMinutes) new Notification("Break Over!", { body: "Time to get back to work!", icon: "img/icon.png" });
            });
        }

        // --- Lightweight Badge Timer ---
        function updateBadgeTimer() {
            const el = document.getElementById('active-badge-timer');
            if (!el) return;

            const start = el.getAttribute('data-start');
            const end = el.getAttribute('data-end');
            
            const now = new Date();
            const currentSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            
            const sSec = sh * 3600 + sm * 60;
            const eSec = eh * 3600 + em * 60;
            
            let diff = (eSec < sSec) ? ((currentSeconds >= sSec) ? (24 * 3600 - currentSeconds) + eSec : eSec - currentSeconds) : (eSec - currentSeconds);
            
            if (diff <= 0) {
                renderActiveCard();
                lucide.createIcons();
                return;
            }

            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            el.textContent = (h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`) + ' Left';
        }
        setInterval(updateBadgeTimer, 1000);

        // --- Focus Mode & Wake Lock ---
        let focusInterval;
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock is active');
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock released');
            }
        }

        // --- Ambient Audio ---
        const ambientAudio = new Audio();
        ambientAudio.loop = true;

        function toggleAudio() {
            const icon = document.getElementById('audio-icon');
            if (ambientAudio.paused) {
                if(ambientAudio.src) {
                    ambientAudio.play();
                    icon.setAttribute('data-lucide', 'pause');
                }
            } else {
                ambientAudio.pause();
                icon.setAttribute('data-lucide', 'play');
            }
            lucide.createIcons();
        }

        function changeAudioSource(src) {
            ambientAudio.src = src;
            if(src) { ambientAudio.play(); document.getElementById('audio-icon').setAttribute('data-lucide', 'pause'); }
            else { ambientAudio.pause(); document.getElementById('audio-icon').setAttribute('data-lucide', 'play'); }
            lucide.createIcons();
        }

        function openFocusMode() {
            // Find active item again to ensure fresh data
            const index = state.activeDayIndex;
            const day = DAYS[index];
            const mode = state.dayModes[day];
            const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // Color Mapping
            const typeColors = {
                [CONSTANTS.ACTIVITY_TYPES.STUDY]: 'indigo',
                [CONSTANTS.ACTIVITY_TYPES.BREAK]: 'amber',
                [CONSTANTS.ACTIVITY_TYPES.CHORE]: 'rose',
                [CONSTANTS.ACTIVITY_TYPES.REVIEW]: 'emerald',
                [CONSTANTS.ACTIVITY_TYPES.REST]: 'sky'
            };

            const item = schedule.find(i => {
                const [sh, sm] = i.start.split(':').map(Number);
                const [eh, em] = i.end.split(':').map(Number);
                const sMin = sh * 60 + sm;
                const eMin = eh * 60 + em;
                return eMin < sMin ? (currentMinutes >= sMin || currentMinutes < eMin) : (currentMinutes >= sMin && currentMinutes < eMin);
            });

            if (!item) return;

            const color = typeColors[item.type] || 'indigo';

            // Populate Modal
            document.getElementById('focus-activity').textContent = item.activity;
            document.getElementById('focus-range').textContent = `${item.start} - ${item.end}`;
            
            // Dynamic Colors
            document.getElementById('focus-activity').className = `text-3xl md:text-5xl font-bold text-center mb-4 tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-${color}-200 to-white`;
            document.getElementById('focus-timer').className = `text-5xl md:text-7xl font-mono font-bold text-${color}-400 tracking-wider drop-shadow-lg tabular-nums`;
            document.getElementById('focus-glow').className = `w-32 h-32 bg-${color}-600/30 rounded-full blur-xl animate-pulse`;

            // Unique 3D Animations
            let animHTML = '';
            if (item.type === CONSTANTS.ACTIVITY_TYPES.STUDY) {
                // Atom Structure (Complex)
                animHTML = `
                    <div class="relative w-full h-full transform-style-3d animate-spin-slow">
                        <div class="atom-ring w-64 h-64 border-${color}-500/50" style="transform: rotateX(70deg)"></div>
                        <div class="atom-ring w-64 h-64 border-${color}-400/50" style="transform: rotateY(70deg)"></div>
                        <div class="atom-ring w-64 h-64 border-${color}-300/50" style="transform: rotateX(-70deg)"></div>
                    </div>`;
            } else if (item.type === CONSTANTS.ACTIVITY_TYPES.BREAK) {
                // Breathing/Floating (Relaxed)
                animHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="absolute w-48 h-48 rounded-full border-4 border-${color}-400/30 animate-ping" style="animation-duration: 3s"></div>
                        <div class="absolute w-56 h-56 rounded-full border-2 border-${color}-300/20 animate-pulse"></div>
                    </div>`;
            } else if (item.type === CONSTANTS.ACTIVITY_TYPES.CHORE) {
                // Mechanical/Gears (Active)
                animHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="absolute w-60 h-60 rounded-full border-4 border-dashed border-${color}-500/40 animate-spin-slow"></div>
                        <div class="absolute w-40 h-40 rounded-full border-4 border-dotted border-${color}-400/60 animate-spin-reverse"></div>
                    </div>`;
            } else if (item.type === CONSTANTS.ACTIVITY_TYPES.REVIEW) {
                // Radar/Scanning (Focus)
                animHTML = `
                    <div class="relative w-full h-full transform-style-3d animate-spin-slow">
                        <div class="atom-ring w-64 h-64 border-4 border-${color}-500/60" style="transform: rotateX(80deg)"></div>
                        <div class="atom-ring w-56 h-56 border-2 border-${color}-400/40" style="transform: rotateY(80deg)"></div>
                    </div>`;
            } else {
                // Rest (Calm Orbit)
                animHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="absolute w-64 h-64 rounded-full border border-${color}-300/20 animate-pulse"></div>
                        <div class="absolute w-56 h-56 rounded-full border border-${color}-200/10" style="animation: spin-3d 20s linear infinite"></div>
                    </div>`;
            }
            
            // Inject Animation (keeping the glow and icon container)
            const wrapper = document.getElementById('focus-anim-wrapper');
            // Remove old animation div if exists (first child)
            if(wrapper.firstElementChild && wrapper.firstElementChild.id !== 'glow-wrapper' && wrapper.firstElementChild.id !== 'focus-icon') wrapper.firstElementChild.remove();
            wrapper.insertAdjacentHTML('afterbegin', animHTML);

            // Icon
            const iconName = getIcon(item);
            if (iconName === 'custom-logo') {
                document.getElementById('focus-icon').innerHTML = `<img src="img/icon.png" width="64" height="64" class="object-contain drop-shadow-2xl">`;
            } else {
                document.getElementById('focus-icon').innerHTML = `<i data-lucide="${iconName}" width="64" height="64" class="text-${color}-100"></i>`;
            }
            lucide.createIcons();

            // Show Modal
            document.getElementById('focus-modal').classList.remove('hidden');
            requestWakeLock();
            
            // Activate Fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }

            // Start Timer
            const [eh, em] = item.end.split(':').map(Number);
            let target = new Date();
            target.setHours(eh, em, 0, 0);
            // Handle overnight tasks (if end time is tomorrow relative to now)
            if (target < new Date() && (eh * 60 + em) < currentMinutes) target.setDate(target.getDate() + 1);

            clearInterval(focusInterval);
            const updateFocusTimer = () => {
                const diff = target - new Date();
                if (diff <= 0) {
                    closeFocusMode();
                    return;
                }
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('focus-timer').textContent = `${h}:${m}:${s}`;
            };
            updateFocusTimer();
            focusInterval = setInterval(updateFocusTimer, 1000);
        }

        function closeFocusMode() {
            document.getElementById('focus-modal').classList.add('hidden');
            clearInterval(focusInterval);
            releaseWakeLock();
            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(e => console.log(e));
            }
            ambientAudio.pause();
            document.getElementById('audio-icon').setAttribute('data-lucide', 'play');
        }

        // --- Netlify Backup Logic ---
        function backupToNetlify() {
            const btn = document.getElementById('btn-backup-netlify');
            const originalContent = btn.innerHTML;
            
            // Loading State
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Sending...`;
            lucide.createIcons();
            btn.disabled = true;

            const formData = new FormData();
            formData.append('form-name', 'backup');
            formData.append('data', JSON.stringify(state));
            formData.append('timestamp', new Date().toLocaleString());

            fetch('/', {
                method: 'POST',
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams(formData).toString()
            })
            .then(() => {
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Saved!`;
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = originalContent; btn.disabled = false; lucide.createIcons(); }, 2000);
            })
            .catch((error) => {
                console.error('Backup failed:', error);
                btn.innerHTML = `<i data-lucide="alert-circle" class="w-4 h-4"></i> Error`;
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = originalContent; btn.disabled = false; lucide.createIcons(); }, 2000);
            });
        }

        // --- Import / Export Logic ---
        function exportState() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "gate_planner_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importState(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (importedState && typeof importedState === 'object') {
                        state = { ...state, ...importedState };
                        saveState();
                        renderApp();
                        alert('State restored successfully!');
                    } else {
                        alert('Invalid JSON file.');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error parsing JSON file.');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- Init ---
        const updateTimer = () => {
            const diff = new Date(CONSTANTS.EXAM_DATE) - new Date();
            if(diff>0) {
                const d = Math.floor(diff/(864e5)), h = Math.floor((diff/36e5)%24);
                document.getElementById('desktop-countdown').textContent = `${d} Days : ${h} Hrs`;
                document.getElementById('mobile-countdown-days').textContent = d;
            }
            if(state.activeDayIndex === currentDayIndex) {
                renderActiveCard(); 
                lucide.createIcons();
            }
            checkNotifications();
        };
        updateTimer(); setInterval(updateTimer, 60000);

        // Check for Widget Mode (?mode=widget)
        if (new URLSearchParams(window.location.search).get('mode') === 'widget') {
            document.body.classList.add('widget-mode');
        }

        // --- PWA Install Logic ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if(btn) btn.classList.remove('hidden');
        });

        async function installApp() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            if(outcome === 'accepted') document.getElementById('install-btn').classList.add('hidden');
        }

        initTheme();
        renderApp();
        setTimeout(() => document.getElementById('day-nav').children[state.activeDayIndex]?.scrollIntoView({ block: 'nearest', inline: 'center' }), 100);

    </script>
</body>
</html>
