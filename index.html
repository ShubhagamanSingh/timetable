<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE CSE 2026 Strategic Planner</title>
    <!-- Icons & Share Image -->
    <link rel="icon" type="image/png" href="img/icon.png">
    <link rel="apple-touch-icon" href="img/icon.png">
    <meta property="og:image" content="img/icon.png">
    <meta name="twitter:image" content="img/icon.png">
    <link rel="manifest" href="manifest.json">
    <!-- Mobile Widget / PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(203, 213, 225, 0.5); border-radius: 20px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background-color: rgba(148, 163, 184, 0.8); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .transition-all-smooth { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Calendar Styles */
        .calendar-day:hover { background-color: #EEF2FF; }
        .calendar-day.today { border: 2px solid #4F46E5; font-weight: bold; }
        .calendar-day.has-topic { background-color: #E0E7FF; color: #4338CA; }
        
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #E2E8F0;
            border-radius: 2px;
        }

        /* Widget Mode Styles (Triggered by ?mode=widget) */
        body.widget-mode { background-color: transparent !important; min-height: 0 !important; }
        body.widget-mode header,
        body.widget-mode #day-nav,
        body.widget-mode .lg\:hidden.fixed,
        body.widget-mode #mobile-dashboard-modal { display: none !important; }
        body.widget-mode main { padding: 0 !important; display: block !important; width: 100% !important; max-width: 100% !important; }
        body.widget-mode #dashboard-sidebar { display: none !important; }
        body.widget-mode .animate-enter { box-shadow: none; border: none; margin: 0 !important; width: 100% !important; border-radius: 0 !important; }

        /* Focus Mode 3D Animation */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .animate-spin-slow { animation: spin-3d 8s linear infinite; }
        .animate-spin-reverse { animation: spin-3d-reverse 12s linear infinite; }
        
        @keyframes spin-3d {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            100% { transform: rotateX(360deg) rotateY(180deg) rotateZ(360deg); }
        }
        @keyframes spin-3d-reverse {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
            100% { transform: rotateX(-360deg) rotateY(-180deg) rotateZ(-360deg); }
        }

        .atom-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-800 pb-20 lg:pb-12 flex flex-col">

    <!-- Navbar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm">
                    <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900 leading-none">GATE '26</h1>
                    <p class="text-xs text-slate-500 font-medium">Strategic Planner</p>
                </div>
            </div>
            
            <div class="hidden md:flex items-center gap-6">
                <div class="text-right">
                    <div class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Time Remaining</div>
                    <div id="desktop-countdown" class="text-sm font-bold text-indigo-600 font-mono">Loading...</div>
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="text-right">
                    <div class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Weekly Goal</div>
                    <div id="desktop-hours" class="text-sm font-bold text-emerald-600 font-mono">0 Hours</div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 py-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- LEFT COLUMN: Scheduler (Takes up 8 columns on Desktop) -->
        <div class="lg:col-span-8 flex flex-col">
            <!-- Mobile Stats -->
            <div class="md:hidden grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 text-center">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wide">Days Left</div>
                    <div id="mobile-countdown-days" class="text-xl font-bold text-indigo-600">--</div>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 text-center">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wide">Wkly Hours</div>
                    <div id="mobile-hours" class="text-xl font-bold text-emerald-600">--</div>
                </div>
            </div>

            <!-- Day Slider Navigation -->
            <div class="relative mb-6">
                <div class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-slate-100 to-transparent z-10 pointer-events-none"></div>
                <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-slate-100 to-transparent z-10 pointer-events-none"></div>
                <div id="day-nav" class="flex overflow-x-auto no-scrollbar gap-2 py-1 px-1 snap-x scroll-smooth"></div>
            </div>

            <!-- Active Content Area -->
            <div id="active-content" class="flex-1 flex flex-col gap-6"></div>
        </div>

        <!-- RIGHT COLUMN: Dashboard (Takes up 4 columns on Desktop, Hidden on Mobile unless toggled) -->
        <div id="dashboard-sidebar" class="hidden lg:flex lg:col-span-4 flex-col gap-6">
            <!-- Reusable Dashboard Content Function will populate this -->
        </div>

    </main>

    <!-- Mobile Dashboard Toggle (Floating Action Button) -->
    <button onclick="toggleMobileDashboard()" class="lg:hidden fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-lg z-50 hover:bg-indigo-700 transition-colors shadow-indigo-500/30">
        <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
    </button>

    <!-- Mobile Dashboard Modal Overlay -->
    <div id="mobile-dashboard-modal" class="fixed inset-0 bg-slate-900/50 z-40 hidden flex justify-end">
        <div class="bg-slate-100 w-full max-w-md h-full overflow-y-auto p-6 flex flex-col gap-6 shadow-2xl transform transition-transform duration-300 translate-x-full" id="mobile-dashboard-content">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-slate-800">My Dashboard</h2>
                <button onclick="toggleMobileDashboard()" class="p-2 bg-white rounded-full text-slate-500 hover:text-slate-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Install Button (Hidden by default) -->
            <button id="install-btn" onclick="installApp()" class="hidden w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-slate-700 transition-colors">
                <i data-lucide="download" class="w-5 h-5"></i> Install App to Home Screen
            </button>
            <!-- Dashboard Content Injected Here for Mobile -->
        </div>
    </div>

    <!-- Focus Mode Modal (Dynamic Box) -->
    <div id="focus-modal" class="fixed inset-0 bg-slate-900/95 z-50 hidden flex flex-col items-center justify-center text-white p-6 backdrop-blur-sm transition-opacity duration-300">
        <button onclick="closeFocusMode()" class="absolute top-6 right-6 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors">
            <i data-lucide="x" class="w-8 h-8 text-white"></i>
        </button>
        
        <!-- 3D Animation Container -->
        <div class="relative w-64 h-64 mb-12 perspective-1000 flex items-center justify-center" id="focus-anim-wrapper">
            <!-- Dynamic Animation Injected Here -->
            <!-- Center Pulse -->
            <div id="glow-wrapper" class="absolute inset-0 flex items-center justify-center">
                <div id="focus-glow" class="w-32 h-32 bg-indigo-600/20 rounded-full blur-xl animate-pulse"></div>
            </div>
            <div id="focus-icon" class="absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_0_15px_rgba(99,102,241,0.8)]"></div>
        </div>

        <h2 id="focus-activity" class="text-3xl md:text-5xl font-bold text-center mb-4 tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 to-white"></h2>
        <div id="focus-timer" class="text-5xl md:text-7xl font-mono font-bold text-indigo-400 tracking-wider drop-shadow-lg tabular-nums">00:00:00</div>
        <p id="focus-range" class="mt-4 text-slate-400 text-lg font-medium tracking-wide"></p>
        <div class="mt-8 flex items-center gap-2 text-sm text-slate-500">
            <i data-lucide="screen-share" class="w-4 h-4"></i> Screen Wake Lock Active
        </div>
    </div>

    <script>
        // --- Data ---
        const CONSTANTS = {
            EXAM_DATE: '2026-02-01T09:00:00',
            MODES: {
                LIBRARY: 'library',
                HOME: 'home',
            },
            ACTIVITY_TYPES: {
                STUDY: 'study',
                BREAK: 'break',
                CHORE: 'chore',
                REVIEW: 'review',
                REST: 'rest',
            }
        };

        const SUBJECTS = [
            "Data Structures", "Algorithms", "Operating Systems", 
            "DBMS", "Computer Networks", "Theory of Computation", 
            "Compiler Design", "Digital Logic", "COA", "Engineering Math"
        ];

        const LIBRARY_SCHEDULE = [
            { start: "04:00", end: "06:00", activity: "Meditation & Exercise", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 2 },
            { start: "06:00", end: "08:00", activity: "Strategy & Study Plan", type: CONSTANTS.ACTIVITY_TYPES.REVIEW, duration: 2 },
            { start: "08:00", end: "09:00", activity: "Bath & Breakfast", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 1 },
            { start: "09:00", end: "15:00", activity: "Study Session I", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 6 },
            { start: "15:00", end: "16:00", activity: "Lunch Break", type: CONSTANTS.ACTIVITY_TYPES.BREAK, duration: 1 },
            { start: "16:00", end: "21:30", activity: "Study Session II", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 5.5 },
            { start: "21:30", end: "22:30", activity: "Dinner & Relax", type: CONSTANTS.ACTIVITY_TYPES.BREAK, duration: 1 },
            { start: "22:30", end: "04:00", activity: "Sleep", type: CONSTANTS.ACTIVITY_TYPES.REST, duration: 5.5 },
        ];

        const HOME_SCHEDULE = [
            { start: "04:00", end: "06:00", activity: "Meditation & Exercise", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 2 },
            { start: "06:00", end: "08:00", activity: "Strategy & Study Plan", type: CONSTANTS.ACTIVITY_TYPES.REVIEW, duration: 2 },
            { start: "08:00", end: "09:00", activity: "Bath & Breakfast", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 1 },
            { start: "09:00", end: "12:30", activity: "Morning Study Block", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 3.5 },
            { start: "12:30", end: "14:30", activity: "Kitchen Duties & Lunch", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 2 },
            { start: "14:30", end: "17:30", activity: "Afternoon Study Block", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 3 },
            { start: "17:30", end: "18:00", activity: "Tea / Walk", type: CONSTANTS.ACTIVITY_TYPES.BREAK, duration: 0.5 },
            { start: "18:00", end: "20:00", activity: "Evening Study Block", type: CONSTANTS.ACTIVITY_TYPES.STUDY, duration: 2 },
            { start: "20:00", end: "21:30", activity: "Dinner Prep & Eating", type: CONSTANTS.ACTIVITY_TYPES.CHORE, duration: 1.5 },
            { start: "21:30", end: "22:30", activity: "Night Revision / Extra", type: CONSTANTS.ACTIVITY_TYPES.REVIEW, duration: 1 },
            { start: "22:30", end: "04:00", activity: "Sleep", type: CONSTANTS.ACTIVITY_TYPES.REST, duration: 5.5 },
        ];

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const SHORT_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        const jsDay = new Date().getDay(); 
        const currentDayIndex = jsDay === 0 ? 6 : jsDay - 1;

        // --- State Management with LocalStorage ---
        function loadState() {
            const saved = localStorage.getItem('gatePlannerState');
            const defaultState = {
                activeDayIndex: currentDayIndex,
                dayModes: {
                    Monday: CONSTANTS.MODES.LIBRARY, Tuesday: CONSTANTS.MODES.LIBRARY, Wednesday: CONSTANTS.MODES.LIBRARY,
                    Thursday: CONSTANTS.MODES.LIBRARY, Friday: CONSTANTS.MODES.LIBRARY, Saturday: CONSTANTS.MODES.HOME, Sunday: CONSTANTS.MODES.HOME
                },
                topicLogs: {}, 
                subjectProgress: SUBJECTS.reduce((acc, sub) => ({...acc, [sub]: 0}), {}), // Default 0%
                calendarMonth: new Date().getMonth(),
                calendarYear: new Date().getFullYear()
            };

            if (saved) {
                const parsed = JSON.parse(saved);
                // Merge to ensure new fields exists if version changes
                return { ...defaultState, ...parsed, activeDayIndex: currentDayIndex, calendarMonth: new Date().getMonth() };
            }
            return defaultState;
        }

        let state = loadState();

        function saveState() {
            localStorage.setItem('gatePlannerState', JSON.stringify(state));
        }

        // --- Logic ---

        function toggleMobileDashboard() {
            const modal = document.getElementById('mobile-dashboard-modal');
            const content = document.getElementById('mobile-dashboard-content');
            
            if (modal.classList.contains('hidden')) {
                // Open
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('translate-x-full');
                }, 10);
                renderDashboard(); // Update views
            } else {
                // Close
                content.classList.add('translate-x-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        function updateProgress(subject, value) {
            state.subjectProgress[subject] = value;
            saveState();
            
            // Use data attributes for robust selection across desktop/mobile
            const safeName = subject.replace(/\s/g, '');
            document.querySelectorAll(`[data-subject-progress-value="${safeName}"]`).forEach(el => el.textContent = `${value}%`);
            document.querySelectorAll(`[data-subject-progress-bar="${safeName}"]`).forEach(el => el.style.width = `${value}%`);
        }

        function handleDateClick(day) {
            const dateKey = `${state.calendarYear}-${state.calendarMonth}-${day}`;
            const currentTopic = state.topicLogs?.[dateKey] || "";
            const newTopic = prompt(`Log completed topic for ${state.calendarMonth+1}/${day}:`, currentTopic);
            
            if (newTopic !== null) {
                if(!state.topicLogs) state.topicLogs = {};
                state.topicLogs[dateKey] = newTopic;
                saveState();
                renderDashboard(); // Re-render both views
            }
        }

        function changeMonth(delta) {
            state.calendarMonth += delta;
            if(state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; }
            if(state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; }
            renderDashboard(); // Re-render both views
        }

        // --- Rendering Helpers ---

        function getColors(type) {
            switch (type) {
                case CONSTANTS.ACTIVITY_TYPES.STUDY: return 'bg-indigo-100 text-indigo-800 border-l-4 border-indigo-500';
                case CONSTANTS.ACTIVITY_TYPES.BREAK: return 'bg-amber-50 text-amber-700 border-l-4 border-amber-400';
                case CONSTANTS.ACTIVITY_TYPES.CHORE: return 'bg-rose-50 text-rose-700 border-l-4 border-rose-400';
                case CONSTANTS.ACTIVITY_TYPES.REVIEW: return 'bg-emerald-50 text-emerald-700 border-l-4 border-emerald-500';
                case CONSTANTS.ACTIVITY_TYPES.REST: return 'bg-slate-100 text-slate-700 border-l-4 border-slate-400';
                default: return 'bg-gray-50 text-gray-700';
            }
        }

        function getIcon(item) {
            const act = item.activity.toLowerCase();
            if (act.includes('meditation') || act.includes('exercise')) return 'dumbbell';
            if (act.includes('strategy')) return 'target';
            if (act.includes('bath') || act.includes('breakfast')) return 'coffee';
            if (act.includes('lunch') || act.includes('dinner') || act.includes('eating')) return 'utensils';
            if (act.includes('walk')) return 'footprints';
            if (act.includes('sleep')) return 'moon';
            
            if (item.type === CONSTANTS.ACTIVITY_TYPES.STUDY) return 'book-open';
            if (item.type === CONSTANTS.ACTIVITY_TYPES.BREAK) return 'coffee';
            if (item.type === CONSTANTS.ACTIVITY_TYPES.CHORE) return 'home';
            return 'brain-circuit';
        }

        // --- Render Main Scheduler --- 
        function renderNav() {
            const navContainer = document.getElementById('day-nav');
            const html = DAYS.map((day, index) => {
                const isActive = index === state.activeDayIndex;
                const isToday = index === currentDayIndex;
                return `
                    <button onclick="state.activeDayIndex=${index}; renderApp(); document.getElementById('day-nav').children[${index}].scrollIntoView({behavior:'smooth', inline:'center'})"
                        class="flex-none px-6 py-3 rounded-full text-sm font-semibold transition-all-smooth snap-center whitespace-nowrap border ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:border-indigo-300 hover:text-indigo-600'}">
                        ${isToday ? 'Today' : SHORT_DAYS[index]}
                    </button>
                `;
            }).join('');
            if (navContainer.innerHTML !== html) navContainer.innerHTML = html;
        }

        function renderActiveCard() {
            const index = state.activeDayIndex;
            const day = DAYS[index];
            const mode = state.dayModes[day];
            const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;
            // Calculate a week index to rotate subjects so all 10 are covered over time
            const currentWeek = Math.floor(Date.now() / (7 * 24 * 60 * 60 * 1000));
            const subject = SUBJECTS[(index + currentWeek) % SUBJECTS.length];
            const studyHours = schedule.reduce((acc, curr) => (curr.type === CONSTANTS.ACTIVITY_TYPES.STUDY || curr.type === CONSTANTS.ACTIVITY_TYPES.REVIEW) ? acc + curr.duration : acc, 0);

            // Time checking logic for highlighting
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const isToday = index === currentDayIndex;
            const isCurrent = (start, end) => {
                if (!isToday) return false;
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);
                const sMin = sh * 60 + sm;
                const eMin = eh * 60 + em;
                return eMin < sMin ? (currentMinutes >= sMin || currentMinutes < eMin) : (currentMinutes >= sMin && currentMinutes < eMin);
            };

            const cardHTML = `
                <div class="animate-enter bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden flex flex-col flex-1 mx-auto w-full">
                    <div class="p-6 ${mode === CONSTANTS.MODES.LIBRARY ? 'bg-gradient-to-br from-blue-600 to-indigo-700' : 'bg-gradient-to-br from-orange-500 to-rose-600'} text-white relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 text-white opacity-10 rotate-12"><i data-lucide="calendar" width="140" height="140"></i></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h2 class="text-3xl font-bold mb-1">${day}</h2>
                                    <div class="flex items-center gap-2 text-indigo-100 text-sm font-medium"><i data-lucide="laptop-2" class="w-4 h-4"></i><span>Focus: ${subject}</span></div>
                                </div>
                                <button onclick="state.dayModes['${day}'] = state.dayModes['${day}'] === CONSTANTS.MODES.LIBRARY ? CONSTANTS.MODES.HOME : CONSTANTS.MODES.LIBRARY; saveState(); renderApp();" class="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg backdrop-blur-sm transition-all text-sm font-semibold border border-white/20">
                                    <span>${mode === CONSTANTS.MODES.LIBRARY ? 'Library Mode' : 'Home Mode'}</span><i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-4 mt-6">
                                <div class="bg-black/20 backdrop-blur-sm px-4 py-2 rounded-lg">
                                    <div class="text-xs text-white/70 uppercase font-bold tracking-wider">Total Study</div>
                                    <div class="text-2xl font-bold leading-none mt-1">${studyHours} <span class="text-sm font-normal opacity-80">hrs</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6 bg-slate-50 flex-1">
                        ${schedule.map(item => {
                            const active = isCurrent(item.start, item.end);
                            const activeStyles = active ? 'ring-2 ring-indigo-600 ring-offset-2 scale-[1.02] shadow-lg z-10 relative cursor-pointer' : 'hover:shadow-md';
                            
                            let remainingBadge = '';
                            if (active) {
                                const [sh, sm] = item.start.split(':').map(Number);
                                const [eh, em] = item.end.split(':').map(Number);
                                const sMin = sh * 60 + sm;
                                const eMin = eh * 60 + em;
                                let diff = (eMin < sMin) ? ((currentMinutes >= sMin) ? (24 * 60 - currentMinutes) + eMin : eMin - currentMinutes) : (eMin - currentMinutes);
                                
                                const h = Math.floor(diff / 60);
                                const m = diff % 60;
                                const timeText = h > 0 ? `${h}h ${m}m` : `${m}m`;
                                const colorClass = diff < 30 ? 'from-rose-500 to-orange-500' : 'from-indigo-600 to-purple-600';
                                remainingBadge = `<span class="absolute -top-2 -right-2 bg-gradient-to-r ${colorClass} text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg animate-pulse border border-white/20 flex items-center gap-1"><i data-lucide="timer" class="w-3 h-3"></i> ${timeText} Left</span>`;
                            }

                            return `
                            <div ${active ? 'onclick="openFocusMode()"' : ''} class="flex items-center p-4 mb-3 rounded-lg text-sm transition-all ${activeStyles} ${getColors(item.type)}">
                                ${remainingBadge}
                                <div class="mr-4 opacity-70"><i data-lucide="${getIcon(item)}" class="w-5 h-5"></i></div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center font-bold text-base mb-1"><span>${item.activity}</span><span class="text-xs opacity-75 font-normal bg-white/50 px-2 py-0.5 rounded-full">${item.start} - ${item.end}</span></div>
                                    <div class="text-xs opacity-90 flex items-center gap-3"><span class="uppercase tracking-wider font-semibold text-[10px]">${item.type}</span><span>${item.duration} hrs</span></div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
            document.getElementById('active-content').innerHTML = cardHTML;
        }

        // --- Dashboard Rendering ---

        // Helper to generate dashboard HTML, promoting DRY principle
        function getDashboardContentHTML() {
            // Calendar Logic
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const daysInMonth = new Date(state.calendarYear, state.calendarMonth + 1, 0).getDate();
            const firstDay = new Date(state.calendarYear, state.calendarMonth, 1).getDay(); // 0 = Sun
            const startOffset = firstDay === 0 ? 6 : firstDay - 1;
            
            let calendarGrid = Array(startOffset).fill('<div></div>').join('');
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${state.calendarYear}-${state.calendarMonth}-${d}`;
                const hasLog = state.topicLogs?.[dateKey];
                const isToday = d === new Date().getDate() && state.calendarMonth === new Date().getMonth() && state.calendarYear === new Date().getFullYear();
                
                calendarGrid += `
                    <div onclick="handleDateClick(${d})" class="calendar-day ${isToday ? 'today' : ''} ${hasLog ? 'has-topic' : ''} aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer text-sm relative transition-colors bg-slate-50 text-slate-600">
                        ${d}
                        ${hasLog ? `<div class="w-1.5 h-1.5 bg-indigo-500 rounded-full mt-1"></div>` : ''}
                    </div>
                `;
            }

            // Progress Logic using data-attributes instead of IDs
            const progressHTML = SUBJECTS.map((sub) => {
                const safeName = sub.replace(/\s/g,'');
                const val = state.subjectProgress[sub] || 0;
                return `
                    <div class="mb-4">
                        <div class="flex justify-between text-xs font-semibold mb-1 text-slate-600">
                            <span>${sub}</span>
                            <span data-subject-progress-value="${safeName}" class="text-indigo-600">${val}%</span>
                        </div>
                        <div class="relative h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div data-subject-progress-bar="${safeName}" class="absolute top-0 left-0 h-full bg-indigo-500 rounded-full transition-all duration-300" style="width: ${val}%"></div>
                        </div>
                        <input type="range" min="0" max="100" value="${val}" 
                            oninput="updateProgress('${sub}', this.value)"
                            class="w-full absolute -mt-3 opacity-0 cursor-pointer h-6">
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <h3 class="font-bold text-slate-800">${monthNames[state.calendarMonth]} ${state.calendarYear}</h3>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-slate-400 uppercase">
                        ${SHORT_DAYS.map(d => `<div>${d.slice(0,1)}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1">${calendarGrid}</div>
                    <div class="mt-3 text-xs text-center text-slate-400">Tap a date to log covered topics</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex-1">
                    <div class="flex items-center gap-2 mb-4">
                         <div class="bg-indigo-100 p-1.5 rounded text-indigo-600"><i data-lucide="bar-chart-3" class="w-4 h-4"></i></div>
                         <h3 class="font-bold text-slate-800">Syllabus Progress</h3>
                    </div>
                    <div class="overflow-y-auto max-h-[400px] pr-2 scrollbar-thin">${progressHTML}</div>
                </div>
            `;
        }

        function renderDashboard() {
            const desktopSidebar = document.getElementById('dashboard-sidebar');
            const mobileModalContent = document.getElementById('mobile-dashboard-content');

            // If dragging slider, don't re-render to maintain focus/performance
            if (document.activeElement.type === 'range' && (desktopSidebar.contains(document.activeElement) || mobileModalContent.contains(document.activeElement))) {
                return;
            }

            const dashboardContentHTML = getDashboardContentHTML();

            if (desktopSidebar) {
                desktopSidebar.innerHTML = dashboardContentHTML;
            }
            
            if (mobileModalContent) {
                // For mobile, preserve the header and inject the content
                mobileModalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold text-slate-800">My Dashboard</h2>
                        <button onclick="toggleMobileDashboard()" class="p-2 bg-white rounded-full text-slate-500 hover:text-slate-800">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    ${dashboardContentHTML}
                `;
            }
            
            lucide.createIcons();
        }

        function renderApp() {
            renderNav();
            renderActiveCard();
            renderDashboard();
            
            // Calc Totals
            const totalHours = Object.keys(state.dayModes).reduce((acc, day) => {
                const mode = state.dayModes[day];
                const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;
                return acc + schedule.reduce((sAcc, item) => (item.type === CONSTANTS.ACTIVITY_TYPES.STUDY || item.type === CONSTANTS.ACTIVITY_TYPES.REVIEW) ? sAcc + item.duration : sAcc, 0);
            }, 0);
            
            document.getElementById('desktop-hours').textContent = `${totalHours} Hours`;
            document.getElementById('mobile-hours').textContent = totalHours;
            lucide.createIcons();
        }

        // --- Focus Mode & Wake Lock ---
        let focusInterval;
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock is active');
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock released');
            }
        }

        function openFocusMode() {
            // Find active item again to ensure fresh data
            const index = state.activeDayIndex;
            const day = DAYS[index];
            const mode = state.dayModes[day];
            const schedule = mode === CONSTANTS.MODES.LIBRARY ? LIBRARY_SCHEDULE : HOME_SCHEDULE;
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // Color Mapping
            const typeColors = {
                [CONSTANTS.ACTIVITY_TYPES.STUDY]: 'indigo',
                [CONSTANTS.ACTIVITY_TYPES.BREAK]: 'amber',
                [CONSTANTS.ACTIVITY_TYPES.CHORE]: 'rose',
                [CONSTANTS.ACTIVITY_TYPES.REVIEW]: 'emerald',
                [CONSTANTS.ACTIVITY_TYPES.REST]: 'sky'
            };

            const item = schedule.find(i => {
                const [sh, sm] = i.start.split(':').map(Number);
                const [eh, em] = i.end.split(':').map(Number);
                const sMin = sh * 60 + sm;
                const eMin = eh * 60 + em;
                return eMin < sMin ? (currentMinutes >= sMin || currentMinutes < eMin) : (currentMinutes >= sMin && currentMinutes < eMin);
            });

            if (!item) return;

            const color = typeColors[item.type] || 'indigo';

            // Populate Modal
            document.getElementById('focus-activity').textContent = item.activity;
            document.getElementById('focus-range').textContent = `${item.start} - ${item.end}`;
            
            // Dynamic Colors
            document.getElementById('focus-activity').className = `text-3xl md:text-5xl font-bold text-center mb-4 tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-${color}-200 to-white`;
            document.getElementById('focus-timer').className = `text-5xl md:text-7xl font-mono font-bold text-${color}-400 tracking-wider drop-shadow-lg tabular-nums`;
            document.getElementById('focus-glow').className = `w-32 h-32 bg-${color}-600/30 rounded-full blur-xl animate-pulse`;

            // Unique 3D Animations
            let animHTML = '';
            if (item.type === CONSTANTS.ACTIVITY_TYPES.STUDY) {
                // Atom Structure (Complex)
                animHTML = `
                    <div class="relative w-full h-full transform-style-3d animate-spin-slow">
                        <div class="atom-ring w-64 h-64 border-${color}-500/50" style="transform: rotateX(70deg)"></div>
                        <div class="atom-ring w-64 h-64 border-${color}-400/50" style="transform: rotateY(70deg)"></div>
                        <div class="atom-ring w-64 h-64 border-${color}-300/50" style="transform: rotateX(-70deg)"></div>
                    </div>`;
            } else if (item.type === CONSTANTS.ACTIVITY_TYPES.BREAK) {
                // Breathing/Floating (Relaxed)
                animHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="absolute w-48 h-48 rounded-full border-4 border-${color}-400/30 animate-ping" style="animation-duration: 3s"></div>
                        <div class="absolute w-56 h-56 rounded-full border-2 border-${color}-300/20 animate-pulse"></div>
                    </div>`;
            } else if (item.type === CONSTANTS.ACTIVITY_TYPES.CHORE) {
                // Mechanical/Gears (Active)
                animHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="absolute w-60 h-60 rounded-full border-4 border-dashed border-${color}-500/40 animate-spin-slow"></div>
                        <div class="absolute w-40 h-40 rounded-full border-4 border-dotted border-${color}-400/60 animate-spin-reverse"></div>
                    </div>`;
            } else if (item.type === CONSTANTS.ACTIVITY_TYPES.REVIEW) {
                // Radar/Scanning (Focus)
                animHTML = `
                    <div class="relative w-full h-full transform-style-3d animate-spin-slow">
                        <div class="atom-ring w-64 h-64 border-4 border-${color}-500/60" style="transform: rotateX(80deg)"></div>
                        <div class="atom-ring w-56 h-56 border-2 border-${color}-400/40" style="transform: rotateY(80deg)"></div>
                    </div>`;
            } else {
                // Rest (Calm Orbit)
                animHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="absolute w-64 h-64 rounded-full border border-${color}-300/20 animate-pulse"></div>
                        <div class="absolute w-56 h-56 rounded-full border border-${color}-200/10" style="animation: spin-3d 20s linear infinite"></div>
                    </div>`;
            }
            
            // Inject Animation (keeping the glow and icon container)
            const wrapper = document.getElementById('focus-anim-wrapper');
            // Remove old animation div if exists (first child)
            if(wrapper.firstElementChild && wrapper.firstElementChild.id !== 'glow-wrapper' && wrapper.firstElementChild.id !== 'focus-icon') wrapper.firstElementChild.remove();
            wrapper.insertAdjacentHTML('afterbegin', animHTML);

            // Icon
            const iconName = getIcon(item);
            document.getElementById('focus-icon').innerHTML = `<i data-lucide="${iconName}" width="64" height="64" class="text-${color}-100"></i>`;
            lucide.createIcons();

            // Show Modal
            document.getElementById('focus-modal').classList.remove('hidden');
            requestWakeLock();
            
            // Activate Fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }

            // Start Timer
            const [eh, em] = item.end.split(':').map(Number);
            let target = new Date();
            target.setHours(eh, em, 0, 0);
            // Handle overnight tasks (if end time is tomorrow relative to now)
            if (target < new Date() && (eh * 60 + em) < currentMinutes) target.setDate(target.getDate() + 1);

            clearInterval(focusInterval);
            const updateFocusTimer = () => {
                const diff = target - new Date();
                if (diff <= 0) {
                    closeFocusMode();
                    return;
                }
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('focus-timer').textContent = `${h}:${m}:${s}`;
            };
            updateFocusTimer();
            focusInterval = setInterval(updateFocusTimer, 1000);
        }

        function closeFocusMode() {
            document.getElementById('focus-modal').classList.add('hidden');
            clearInterval(focusInterval);
            releaseWakeLock();
            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(e => console.log(e));
            }
        }

        // --- Init ---
        const updateTimer = () => {
            const diff = new Date(CONSTANTS.EXAM_DATE) - new Date();
            if(diff>0) {
                const d = Math.floor(diff/(864e5)), h = Math.floor((diff/36e5)%24);
                document.getElementById('desktop-countdown').textContent = `${d} Days : ${h} Hrs`;
                document.getElementById('mobile-countdown-days').textContent = d;
            }
            if(state.activeDayIndex === currentDayIndex) {
                renderActiveCard(); 
                lucide.createIcons();
            }
        };
        updateTimer(); setInterval(updateTimer, 60000);

        // Check for Widget Mode (?mode=widget)
        if (new URLSearchParams(window.location.search).get('mode') === 'widget') {
            document.body.classList.add('widget-mode');
        }

        // --- PWA Install Logic ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if(btn) btn.classList.remove('hidden');
        });

        async function installApp() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            if(outcome === 'accepted') document.getElementById('install-btn').classList.add('hidden');
        }

        renderApp();
        setTimeout(() => document.getElementById('day-nav').children[state.activeDayIndex]?.scrollIntoView({ block: 'nearest', inline: 'center' }), 100);

    </script>
</body>
</html>
